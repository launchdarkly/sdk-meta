name: Publish GitHub Pages

on:
  push:
    branches: ['rlamb/feature-comparison-tool']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate HTML
        run: |
          cd tool && go run ./cmd/genhtml -output ../products/features.html -data ../products

      - name: Prepare publish directory
        run: |
          mkdir -p _site
          cp products/features.html _site/index.html

      - name: Create gh-pages branch if it doesn't exist
        run: |
          if ! git ls-remote --exit-code --heads origin gh-pages; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git reset --hard
            git commit --allow-empty -m "Initialize gh-pages branch"
            git push origin gh-pages
            git checkout -
          fi

      - name: Publish to GitHub Pages
        uses: launchdarkly/gh-actions/actions/publish-pages@publish-pages-v1.0.2
        with:
          docs_path: _site
          github_token: ${{ secrets.GITHUB_TOKEN }}
