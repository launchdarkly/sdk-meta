name: CI
on:
  push:
    branches: [ 'main' ]
    paths-ignore:
      - '**.md' # Don't run CI on markdown changes.
  pull_request:
    branches: [ 'main', 'feat/**' ]
    paths-ignore:
      - '**.md'

jobs:
  lints:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Format JSON
        run: |
          ./scripts/ci/format-json.sh
      - name: Ensure no formatting changes needed
        run: git diff --exit-code
      - name: Validate JSON schemas
        run: |
          ./scripts/ci/check-json-schemas.sh
  go-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.22
      - name: Build
        run: go build ./cmd/ingest
      - name: Sanity test
        run: |
          sqlite3 metadata.sqlite3 < ./schemas/sdk_metadata.sql
          ./ingest -db metadata.sqlite3 -metadata ./metadata/launchdarkly_js-core.json -repo launchdarkly/js-core
          length=$(sqlite3 -json metadata.sqlite3 "SELECT * from sdk_repos;" | jq '. | length')
          if [ $length -ne 6 ]; then
            echo "Expected 6 rows in sdk_repos, got $length"
            exit 1
          fi
